<!DOCTYPE html>
<html lang="ko">
<head>
<meta name="viewport" content="width=device-width,user-scalable=no"/>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="title" content="thePAY" />
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta name="author" content="" />
<meta name="image" content="" />
<meta property="og:type" content="website">
<meta property="og:title" content="thePAY">
<meta property="og:description" content="">
<meta property="og:image" content="">
<meta property="og:url" content="">
<title>thePAY</title>
<link rel="stylesheet" href="/assets/common/css/default.css?v=<?=date('YmdHis')?>?">
<link rel="stylesheet" href="/assets/common/css/contents.css?v=<?=date('YmdHis')?>">
<link rel="stylesheet" href="/assets/common/css/custom.css?v=<?=date('YmdHis')?>">
<link rel="canonical" href="">
<link rel="shortcut icon" href="/assets/images/favicon.ico">
<!--[if lt IE 9]>
    <script src="/assets/common/js/html5shiv.js"></script>
<![endif]-->

<style>
    .hidden { display: none; }

    #POPUP_pg_confirm .popup__body,
    #POPUP_move_month .popup__body,
    #POPUP_move_normal .popup__body,
    #POPUP_finish .popup__body { height: auto; padding: 60px 60px; }
    /* .pre-line { white-space: pre-line; } */

    .select_item .off,
    .select_pps .off { display: inline-block; }
    .select_item .on,
    .select_pps .on { display: none; }
    .select_item.on .on,
    .select_pps.on .on { display: inline-block; }
    .select_item.on .off,
    .select_pps.on .off { display: none; }
    .select_item.on a,
    .select_pps.on a { border: 2px solid #000; color: #000; font-weight: 400; }

    .tabmenu_inner .tabmenu_tit { width: 60%; }

    .col2 .int_select_inner { width: 50%;display: inline-block;vertical-align: top;position: relative;list-style: none; }
    .col3 .int_select_inner { width: 33.3%;display: inline-block;vertical-align: top;position: relative;list-style: none; }
    .col4 .int_select_inner { width: 25%;display: inline-block;vertical-align: top;position: relative;list-style: none; }
    #recharge_amt_list .int_select_inner .int_select { padding: 8px; text-align: left; }

    .add_info { font-size: 36px; margin-top: 10px; }

    .tabmenu_inner .tabmenu_tit { /*width: 72%;*/ height: 100%; vertical-align: middle; }
    .tabmenu_inner i { height: 100%; width: 20px;}
    .tabmenu_inner i img { width: 100%; }
    .tab_menu li a { padding: 10px; }

    .popup__body .default_select_inner li { user-select: none;appearance: none; -webkit-tap-highlight-color: rgba(0,0,0,0);}

    .custom_spinner_item { display: inline-block; width: calc(100% - 15px); }
    .custom_spinner_item .prod_amt { float: right; color: mediumblue;}
    .custom_spinner_item .prod_info { font-size: 16px; letter-spacing: -1.5px; white-space: pre-line;
    display: inline-block;
    width: 100%;
    word-break: break-all; }

    .popup__body .default_select_inner li { position: relative; padding-left: 34px; }
    .default_select_inner input[type="radio"] + label > span {
        position: absolute;
        top: 50%;
        left: 0;
        margin-top: -8px;
    }
</style>
</head>
<body>
<!-- WRAP -->
<div id="WRAP" class="bg__gray">
</div>
<!-- //WRAP -->

<div id="template" class="hidden">
    <!-- HEADER -->
    <div id="HEADER" class="hidden">
        <header>
            <h1 class="head__text">{{title_activity_charge_preview_phone}}</h1>
            <button class="head__back"><img src="/assets/images/i_back.png" alt="뒤로"></button>
        </header>
    </div>
    <!-- //HEADER -->

    <!-- CONTAINER -->
    <div id="CONTAINER">
        <div id="FORM_PAGE">
            <div id="FORM_PAGE__CONTENT">
                <div class="l__tabmenu">
                    <ul class="column col2">
                        <li data-tab="pps" class="on"><a href="javascript:;">{{tab_title_charge_normal}}</a></li>
                        <li data-tab="mthRate"><a href="javascript:;">{{tab_title_charge_monthly}}</a></li>
                    </ul>
                </div>

                <fieldset>
                    <div class="l__inner tab_pps tab bg__white">
                        <div class="form-group">
                            <label for="form_phone">{{recharge_number}}</label>
                            <div class="int_phone">
                                <input type="tel" name="form_phone" id="pps_ctn" class="int phone form_phone intFoc" autocomplete="off" placeholder="{{hint_recharge_number}}">
                                <a href="javascript:;" class="btn_Address" id=""><img src="/assets/images/i_address.png" alt="전화부 아이콘"></a>
                                <a href="javascript:;" class="btn_History2" id=""><img src="/assets/images/i_address2.png" alt="전화부 아이콘"></a>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="form_certified">{{recharge_goods}}</label>
                            <div class="tab_menu">
                                <ul id="pps_list" class="column col_2">
                                </ul>
                            </div>
                            <input type="text" name="form_ppsName" id="form_ppsName" class="int" value="" readonly>
                            <div id="add_info" class="add_info"></div>
                        </div>
                        <div class="form-group bot">
                            <label for="form_number">{{recharge_amount}}</label>
                            <div class="int_select_inner">
                                <a href="javascript:;" class="int_select" id="btn_select" readonly></a>
                            </div>
                        </div>
                    </div>

                    <div class="l__inner tab_mthRate tab bg__white" style="display:none;">
                        <div class="form-group">
                            <label for="form_phone">{{recharge_number}}</label>
                            <div class="int_phone">
                                <input type="tel" name="form_phone" id="mthRate_ctn" class="int phone form_phone intFoc" autocomplete="off"  placeholder="{{hint_recharge_number}}">
                                <a href="javascript:;" class="btn_Address" id=""><img src="/assets/images/i_address.png" alt="전화부 아이콘"></a>
                                <a href="javascript:;" class="btn_History2" id=""><img src="/assets/images/i_address2.png" alt="전화부 아이콘"></a>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="form_news_agency">{{montly_plan_select_telecom_title}}</label>
                            <div id="mth_select" class="int_select_inner">
                                <a href="javascript:;" class="int_select" id="btn_select"></a>
                            </div>
                            <div class="news_agency_img margin_t">
                                <img src="/assets/images/news_agency_img.png" alt="이미지">
                            </div>
                            <div id="add_info2" class="add_info"></div>
                        </div>
                        <div class="form-group">
                            <label for="form_amount">{{recharge_amount}}</label>
                            <input type="text" name="form_amount" id="form_amount" class="int" value="" readonly>
                            <div class="int_form margin_t">
                                <div id="recharge_amt_list" class="column col4">
                                    <div class="int_select_inner">
                                        <a href="javascript:;" class="int_select" id="btn_select"></a>
                                    </div>
                                    <div class="int_select_inner">
                                        <a href="javascript:;" class="int_select" id="btn_select"></a>
                                    </div>
                                    <div class="int_select_inner">
                                        <a href="javascript:;" class="int_select" id="btn_select"></a>
                                    </div>
                                    <div class="int_select_inner">
                                        <a href="javascript:;" class="int_select" id="btn_select"></a>
                                    </div>
<!-- 
                                    <li>
                                        <select name="form_amount" id="form_amount" class="int">
                                            <option value="">~29,999</option>
                                        </select>
                                    </li>
                                    <li>
                                        <select name="form_amount2" id="form_amount2" class="int">
                                            <option value="">￦36,300</option>
                                        </select>
                                    </li>
                                    <li>
                                        <select name="form_amount3" id="form_amount3" class="int">
                                            <option value="">~40,000</option>
                                        </select>
                                    </li>
                                    <li>
                                        <select name="form_amount4" id="form_amount4" class="int">
                                            <option value="">~50,000</option>
                                        </select>
                                    </li> -->
                                </div>
                            </div>
                        </div>
                        <div class="form-group bot">
                            <div class="BOX__line">
                                <div class="BOX__line_row">
                                    <!-- <div class="FT__desc2 l__interval4"><strong class="FW__M">[월 정액 요금제 충전 방법]</strong></div> -->
                                    <div id="info" class="FT__desc2">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- div class="line__bot"></div -->

                    <div class="l__inner payment_box">
                        <div class="BOX__line box__shadow bg__white">
                            <div class="BOX__line_row top">
                                <dl class="details_guide_col col_2">
                                    <dd class="details_col col1">
                                        <div class="FT__desc3 subcolor"><strong class="FW__L">{{amount}}</strong></div>
                                        <div class="FT__title4"><strong id="amount"></strong></div>
                                    </dd>
                                </dl>
                            </div>
                            <div class="padding_0 cash_top" style="display:none;">
                                <div class="hr"></div>
                            </div>
                            <div class="BOX__line_row" style="display:none;">
                                <dl class="details_guide_col col_2 checkbox_wrap">
                                    <dd class="details_col col1">
                                        <div class="FT__desc3 subcolor"><strong class="FW__L">{{recharge_thepay_cash}}</strong></div>
                                        <div class="FT__title2" id="user_cash">￦ {{user.displayCash}}</div>
                                    </dd>
                                    <dd class="details_col col2 tar">
                                        <div class="int_check">
                                            <input type="checkbox" id="use_cash" class="use_checkbox"> <label for="use_cash">{{recharge_use}} <span></span></label>
                                        </div>
                                    </dd>
                                </dl>
                            </div>
                            <div class="padding_0 point_top" style="display:none;">
                                <div class="hr"></div>
                            </div>
                            <div class="BOX__line_row" style="display:none;">
                                <dl class="details_guide_col col_2 checkbox_wrap">
                                    <dd class="details_col col1">
                                        <div class="FT__desc3 subcolor"><strong class="FW__L">{{recharge_point}}</strong></div>
                                        <div class="FT__title2" id="user_point">ⓟ {{user.displayPoint}}</div>
                                    </dd>
                                    <dd class="details_col col2 tar">
                                        <div>
                                            <input type="checkbox" id="use_point" class="use_checkbox"> <label for="use_point">{{recharge_use}} <span></span></label>
                                        </div>
                                    </dd>
                                </dl>
                            </div>

                            <div class="padding_0 alarm_top" style="display: none;">
                                <div class="hr"></div>
                            </div>
                            <div class="BOX__line_row" style="display: none;">
                                <dl class="details_guide_col col_2">
                                    <dd class="details_col col1">
                                       <div class="FT__desc3 subcolor"><strong class="FW__L"><!--{{recharge_alarm}}-->Agree to get notifications about the next recharge date</strong></div>
                                    </dd>
                                    <dd class="details_col col2 tar">
                                        <div class="int_check">
                                            <input type="checkbox" id="recharge_alarm"> <label for="recharge_alarm">{{recharge_use}} <span></span></label>
                                        </div>
                                    </dd>
                                </dl>
                            </div>

                            <div class="BOX__line_row bot tac">
                                <div class="FT__title subcolor pad">{{recharge_pay_amount}}</div>
                                <div class="FT__title5 pad"><strong class="point2" id="payment_amount"></strong></div>
                                <div class="FT__desc2 subcolor pad">{{payment_min_amount}}</div>
                            </div>
                        </div>
                    </div>

                    <div class="fixed_btn">
                        <div class="fixed_height"></div>
                        <input type="submit" value="{{btn_recharge}}" class="btn" id="btn_recharge">
                    </div>
                </fieldset>

                <div class="l__popup" id="POPUP_dataCheck">
                    <div class="dim"></div>
                    <div class="l-table">
                        <div class="l-cell">
                            <div class="popup__wrap">
                                <!-- <div class="popup__head">
                                    <div class="popup__title tal">
                                        Recharge Amount
                                    </div>
                                </div> -->
                                <div class="popup__body">
                                    <div class="default_select_inner">
                                        <ul>
                                        </ul>
                                    </div>
                                </div>
                                <div class="popup__foot popup_btns col2">
                                    <a href="javascript:;" class="btn_ok popup__close">{{btn_cancel}}</a>
                                    <a href="javascript:;" class="btn btn_sel">{{btn_confirm}}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="l__popup" id="POPUP_mthrate">
                    <div class="dim"></div>
                    <div class="l-table">
                        <div class="l-cell">
                            <div class="popup__wrap">
                                <div class="popup__body">
                                    <div class="default_select_inner">
                                        <ul>
                                        </ul>
                                    </div>
                                </div>
                                <div class="popup__foot popup_btns col2">
                                    <a href="javascript:;" class="btn_ok popup__close">{{btn_cancel}}</a>
                                    <a href="javascript:;" class="btn btn_sel_mth">{{btn_confirm}}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="l__popup" id="POPUP_amount">
                    <div class="dim"></div>
                    <div class="l-table">
                        <div class="l-cell">
                            <div class="popup__wrap">
                                <div class="popup__body">
                                    <div class="default_select_inner">
                                        <ul>
                                        </ul>
                                    </div>
                                </div>
                                <div class="popup__foot popup_btns col2">
                                    <a href="javascript:;" class="btn_ok popup__close">{{btn_cancel}}</a>
                                    <a href="javascript:;" class="btn btn_sel_amount">{{btn_confirm}}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- pg confirm -->
                <div class="l__popup" id="POPUP_pg_confirm">
                    <div class="dim"></div>
                    <div class="l-table">
                        <div class="l-cell">
                            <div class="popup__wrap">
                                <div class="popup__head">
                                    <div class="popup__title">
                                        {{alert_title_confirm}}
                                    </div>
                                </div>
                                <div class="popup__body">
                                    <div class="l-table">
                                        <div class="l-cell">
                                            <div class="popup__desc FT__desc2">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="popup__foot popup_btns col2">
                                    <a href="javascript:;" class="btn_ok popup__close">{{btn_cancel}}</a>
                                    <a href="javascript:;" class="btn btn_pg_confirm">{{btn_confirm}}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- // pg confirm -->

                <div class="l__popup" id="POPUP_move_month">
                    <div class="dim"></div>
                    <div class="l-table">
                        <div class="l-cell">
                            <div class="popup__wrap">
                                <div class="popup__head">
                                    <div class="popup__title">
                                        {{alert_title_confirm}}
                                    </div>
                                </div>
                                <div class="popup__body">
                                    <div class="l-table">
                                        <div class="l-cell">
                                            <div class="popup__desc FT__desc2">
                                                {{alert_msg_normal_to_month}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="popup__foot popup_btns col2">
                                    <a href="javascript:;" class="btn_ok popup__close">{{btn_cancel}}</a>
                                    <a href="javascript:;" class="btn btn_month_confirm">{{btn_confirm}}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="l__popup" id="POPUP_move_normal">
                    <div class="dim"></div>
                    <div class="l-table">
                        <div class="l-cell">
                            <div class="popup__wrap">
                                <div class="popup__head">
                                    <div class="popup__title">
                                        {{alert_title_confirm}}
                                    </div>
                                </div>
                                <div class="popup__body">
                                    <div class="l-table">
                                        <div class="l-cell">
                                            <div class="popup__desc FT__desc2">
                                                {{alert_msg_month_to_normal}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="popup__foot popup_btns col2">
                                    <a href="javascript:;" class="btn_ok popup__close">{{btn_cancel}}</a>
                                    <a href="javascript:;" class="btn btn_normal_confirm">{{btn_confirm}}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="l__popup" id="POPUP_finish">
                    <div class="dim"></div>
                    <div class="l-table">
                        <div class="l-cell">
                            <div class="popup__wrap">
                                <div class="popup__head">
                                    <div class="popup__title">
                                        {{alert_title_confirm}}
                                    </div>
                                </div>
                                <div class="popup__body">
                                    <div class="l-table">
                                        <div class="l-cell">
                                            <div class="popup__desc FT__desc2">
                                                {{alert_msg_recharge_progress}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="popup__foot">
                                    <a href="javascript:;" class="btn_ok btn_finish_confirm">{{btn_confirm}}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- //LOGIN_PAGE__CONTENT -->
        </div>
    </div>
    <!-- //CONTAINER -->

    <!-- CONTAINER -->
    <div id="CONTAINER" class="full_popup" style="display: none;">
        <div id="thePAY_PAGE">
            <div id="thePAY_PAGE__CONTENT">

                <fieldset>
                    <div class="l__inner">
                        <div class="FT__title l__interval tal">
                        </div>
                    </div>
                    <div class="form-btns fixed_btn">
                        <div class="fixed_height"></div>
                        <input type="submit" value="{{btn_confirm}}" class="btn" id="SUMBIT">
                    </div>
                </fieldset>

            </div><!-- //LOGIN_PAGE__CONTENT -->
        </div>
    </div>
    <!-- //CONTAINER -->
</div>

<form id="send_form" method="GET" action="/recharge.html">
    <input type="hidden" id="mvnoId" name="mvnoId" value="">
    <input type="hidden" id="amt" name="amt" value="">
    <input type="hidden" id="payAmt" name="payAmt" value="">
    <input type="hidden" id="useCash" name="useCash" value="">
    <input type="hidden" id="usePoint" name="usePoint" value="">
    <input type="hidden" id="rcgType" name="rcgType" value="P">
    <input type="hidden" id="rcgSeq" name="rcgSeq" value="">
    <input type="hidden" id="opCode" name="opCode" value="">
    <input type="hidden" id="creditBillType" name="creditBillType" value="">
    <input type="hidden" id="ctn" name="ctn" value="">
    <input type="hidden" id="orderNum" name="orderNum" value="">
    <input type="hidden" id="pgId" name="pgId" value="">
    <input type="hidden" id="noticeContent" name="noticeContent">
    <input type="hidden" id="title" name="title" value="title_activity_pay_phone">
</form>

<!-- 페이지 로딩시 LANG 처리하기 위하여 상단에서 로딩 -->
<script type="text/javascript" src="/assets/common/js/const.js?v=50001"></script>
<script type="text/javascript" src="/assets/common/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/assets/common/js/util.js?v=50001"></script>
<script type="text/javascript" src="/assets/common/js/moment.js"></script>
<script>
var date = moment().format('HHmmss');
var commonPath = '/assets/common/js/common.js?v=' + date;
var apiPath = '/assets/common/js/api.js?v=' + date;
var bridgePath = '/assets/common/js/bridge.js?v=' + date;
util.loadDynamicScript(commonPath);
util.loadDynamicScript(bridgePath);
util.loadDynamicScript(apiPath);
</script>
<script type="text/javascript" src="/assets/common/js/mustache.min.js"></script>
<script type="text/javascript">
var _auth_ctn = COMM_DATA.ANI;
var _ppsList = [];
var _mthList = [];
var _plan = null;
var _tab = 'pps';
var _mthMode = '';
var _sortAmtObj = {};
var _authCtnInfo = {};
var _defaultPPS = 'voice'; // pps 기본값 셋팅
var _isLoadCtn = true; // 최초 로딩시 auth_ctn 사용여부
var _defaultMvnoId = -999; // mvnoId 기본값 셋팅
var _defaultRcgAmt = 0; // rcgAmt 기본값 셋팅

// 인풋 입력 체크
var _inputTimeout = null;
var _isApiLoading = false;

// 실패내역 조회
function ajax_rcg_fail_note(seq) {
    // if (!seq) return false;
    var eDate = moment().format('YYYYMMDDHHmmss');

    // 입력한 값으로 ctn 전송추가
    var ctn = $('#'+_tab+'_ctn').val();

    bridge.callEncParams({ ENC_DATE: eDate },

    function() {
        var params = {
            pinNumber: COMM_DATA.pinNumber,
            CTN: ctn,
            RCG_SEQ: seq,
            ANI: "",
            USER_ID: COMM_DATA.USER_ID,
            LANG: COMM_DATA.LANG,
            SESSION_ID: COMM_DATA.SESSION_ID,
            ENC_DATE: _ENC.ENC_DATE,
            AES256: _ENC.AES256
        };

        api.rcgFaileNote(params, function(res) {
            if (typeof res == 'string') res = JSON.parse(res);

            if (res['O_CODE'] == '0000') {
                var data = res['O_DATA'];

                if (data.noteVisible == 'N') {
                    ajax_pg_rcg();
                    return false;
                }

                // 전체화면 팝업
                if (data.noteSize == 'F') {
                    var popup = $('.full_popup');//$('#POPUP_question')
                    popup.find('.FT__title').html(data.noteContents);

                    bridge.callSetWebViewTitle({ 
                        title: data.noteTitle
                    });

                    popup.show()
                        .siblings('.main_page').hide();

                    $(popup).find('#SUMBIT').off('click').on('click', function() {
                        goBack();
                    });
                    // popup.find('.popup__desc').html(data.noteContents);
                    // setPop(popup, true);
                } else if (data.noteSize == 'A') {
                // alert 형
                    alert(data.noteContents);
                    goBack();
                }
            } else {
                alert(res['O_MSG']);
                // history.back();
            }
        });
    });
}

function ajax_auth_ctn(isLoadCtn) {
    if (!isLoadCtn) return false;
    // else return false;

    var tab = $('.tab_' + _tab);
    var ctn = util.getNum(tab.find('.form_phone').val());
    var eDate = moment().format('YYYYMMDDHHmmss');
    var mobileOs = util.getMobileOS();

    tab.find('.form_phone')
        .blur()
        .focusout();

    bridge.callEncParams({ ENC_DATE: eDate }, 
    function () {
        var params = {
            opCode: 'P',
            pinNumber: COMM_DATA.pinNumber,
            CTN: ctn,
            USER_ID: COMM_DATA.USER_ID,
            LANG: COMM_DATA.LANG,
            ANI: COMM_DATA.ANI,
            TELCOM: COMM_DATA.TELCOM,
            MODEL: COMM_DATA.MODEL,
            OS: (mobileOs == 'and' ? 'adr':'ios') +'@'+COMM_DATA.OS,
            APP_VER: 'thePAY@'+COMM_DATA.APP_VER,
            osLang: COMM_DATA.osLang,
            IMSI: COMM_DATA.IMSI,
            SESSION_ID: COMM_DATA.SESSION_ID,
            ENC_DATE: _ENC.ENC_DATE,
            AES256: _ENC.AES256
        };

        api.authCtn(params, function(res) {
            _isApiLoading = false;
            if (typeof res == 'string') res = JSON.parse(res);

            if (res['O_CODE'] == '0000') {
                var data = res['O_DATA'];

                if (data['O_CODE'] == '0000') {
                    _authCtnInfo = data;
                    _auth_ctn = data['ctn'];

                    setAuthCtnInfo(data);
                }
            } else {
                _auth_ctn = COMM_DATA.ANI;
                if (res['O_CODE'] == '9999') {
                    $('.add_info').empty();

                    // 유효 통신사 없음
                    if (_tab == 'pps') {
                        // var $prodList = $('#pps_list');
                        // $prodList.find('[data-id=voice]').click();
                    } else {
                        if (_mthMode == 'band') {
                            _mthMode = '';
                            renderMthRate(_mthList);
                        }
                        $('.tab_mthRate').find('.news_agency_img').show();

                        setTelecom();
                    }
                } else {
                    alert(res['O_MSG']);
                }
            }
        });
    });
    return;
}

function setAuthCtnInfo(data) {
    if (!data) return false;
    var rcgType = data['rcgtype'];
    var addInfo = data['addInfo'];

    // 선불 요금제의 경우
    if (_tab == 'pps') {
        var $prodList = $('#pps_list');
        var selProd = $prodList.find('.select_pps.on').data('id');
    
        if (addInfo) {
            var html = [];
            var keys = Object.keys(addInfo);

            $.each(keys, function(i, k) {
//                if (!['expiredt', 'balance'].includes(k)) return true;
                // 낮은버전 코드수정
                if (['expiredt', 'balance'].indexOf(k) < 0) return true;
                if (!addInfo[k]) return true;
                html.push(addInfo[k]);
            });

            $('#add_info').html(html.join('<br/>'));
        } else {
            $('#add_info').empty();
        }

        if (rcgType == 'L') {
            if (data['plan'] == 'special') {
                // 선택한 상품이 Data가 아닌경우 voice2 상품 선택
                if (selProd != 'data') {
                    $prodList.find('[data-id=voice2]').click();
                }
            } else {
                // 팝업 표시
                setPop($('#POPUP_move_month'), true);
            }
        } else if (rcgType == 'V') {
            // set voice 
            if (selProd != 'data') {
                $prodList.find('[data-id=voice]').click();
            }
        }
    } 
    // 월정액 인경우
    else {
        if (addInfo) {
            var html = [];
            var keys = Object.keys(addInfo);

            $.each(keys, function(i, k) {
//                if (!['expiredt', 'balance'].includes(k)) return true;
                // 낮은버전 코드수정
                if (['expiredt', 'balance'].indexOf(k) < 0) return true;
                if (!addInfo[k]) return true;
                html.push(addInfo[k]);
            });

            $('#add_info2').html(html.join('<br/>'));
            $('.tab_mthRate').find('.news_agency_img').hide();
        } else {
            $('#add_info2').empty();
            $('.tab_mthRate').find('.news_agency_img').show();
        }

        if (rcgType == 'L') {
            // 밴드 상품인경우 band 금액만 리스트 표시
            // includeBand : Y, prodType : band
            if (data['plan'] == 'band') {
                _mthMode = 'band';
                renderMthRate(_mthList);
            } else {
                if (_mthMode == 'band') {
                    _mthMode = '';
                    renderMthRate(_mthList);
                }
            }

            // 통신사 값이 있는 경우 해당 통신사 선택
            // 금액이 있는경우 해당 금액 선택 없으면 첫번째
            setTelecom(data['mvno'], data['rcgamt']);
        } else if (rcgType == 'V') {
            setPop($('#POPUP_move_normal'), true);
        }
    }
}

function ajax_page_info(isCallCtn) {
    var params = {
        opCode: _tab,
        ANI: COMM_DATA.ANI,
        USER_ID: COMM_DATA.USER_ID,
        pinNumber:COMM_DATA.pinNumber,
        LANG: COMM_DATA.LANG,
        TELCOM: COMM_DATA.TELCOM,
        MODEL: COMM_DATA.MODEL,
        APP_VER: COMM_DATA.APP_VER
    };

    api.subPreloadingAdr(params, function(res) {
        if (typeof res == 'string') res = JSON.parse(res);

        // console.log(COMM_DATA, res);

        if (res['O_CODE'] == '0000') {
            var data = res['O_DATA'];

            if (data['mvnoList']) {
                if ($.isArray(data['mvnoList']['pps'])) {
                    _ppsList = data['mvnoList']['pps'];
                }
                if ($.isArray(data['mvnoList']['mthRate'])) {
                    _mthList = data['mvnoList']['mthRate'];
                }

                if (_tab == 'pps') 
                {
                    renderPPS(_ppsList);
                    // 요금제 만료 알람 hide
                    $('#recharge_alarm').prop('checked', false);
                    $('.alarm_top').hide();
                    $('#recharge_alarm').parents('.BOX__line_row').hide();
                } else {
                    renderMthRate(_mthList);
                    // 요금제 만료 알람 show
                    $('.alarm_top').show();
                    $('#recharge_alarm').parents('.BOX__line_row').show();
                }
            }

            if (isCallCtn) {
                ajax_auth_ctn(isCallCtn);
            }

        } else {
            alert(res['O_MSG']);
        }
    });
}

function ajax_page_remains() {
    var eDate = moment().format('YYYYMMDDHHmmss');
    bridge.callEncParams({ ENC_DATE: eDate }, 
    function () {
        var params = {
            pinNumber: COMM_DATA.pinNumber,
            ANI: COMM_DATA.ANI,
            USER_ID: COMM_DATA.USER_ID,
            LANG: COMM_DATA.LANG,
            SESSION_ID: COMM_DATA.SESSION_ID,
            ENC_DATE: _ENC.ENC_DATE,
            AES256: _ENC.AES256
        };

        api.remains(params, function(res) {
            if (res['O_CODE'] == '0000') {

                var data = res['O_DATA'];

                COMM_DATA.cash = data.cash;
                COMM_DATA.point = data.point;

                /* 가지고 있는 포인트가 금액보다 크면 금액만큼만 표시 */
                renderPoint();
            } else {
                alert(res['O_MSG']);
                // history.back();
            }
        });
    });
}

// PG 유효성 체크
function ajax_pg_rcg() {
    var eDate = moment().format('YYYYMMDDHHmmss');
    bridge.callEncParams({ ENC_DATE: eDate },
    function() {
        var tab = $('.tab_' + _tab);
        var phone = tab.find('.form_phone').val();
        var mvnoId = $('#mvnoId').val();
        var rcgType = $('#rcgType').val();
        var rcgAmt = parseInt(util.getNum($('#amt').val()));
        var useCash = parseInt(util.getNum($('#useCash').val()));
        var usePoint = parseInt(util.getNum($('#usePoint').val()));
        var payAmt =  rcgAmt - useCash - usePoint; // parseInt(util.getNum($('#payAmt').val()));
        var alarmFlag = $('#recharge_alarm').is(':checked') == true ? "Y" : "N";
        var params = {
            opCode: 'NOTICE', 
            pinNumber: COMM_DATA.pinNumber,
            CTN: phone,
            ANI: COMM_DATA.ANI,
            LANG: COMM_DATA.LANG,
            osLang: COMM_DATA.osLang,
            SESSION_ID: COMM_DATA.SESSION_ID,
            ENC_DATE: _ENC.ENC_DATE,
            AES256: _ENC.AES256,
            rcgType: rcgType,
            mvnoId: mvnoId,
            rcgAmt: rcgAmt,
            userCash: useCash,
            userPoint: usePoint,
            payAmt: payAmt,
            alarmFlag: alarmFlag
        };

        api.rcgV4(params, function(res) {
            if (typeof res == 'string') res = JSON.parse(res);

            if (res['O_CODE'] == '0000') {
                var data = res['O_DATA'];
                var popup = $('#POPUP_pg_confirm');
                // console.log(data);

                // 리턴 결과 값에 따라서 변동
                $('#ctn').val(phone);
                $('#rcgSeq').val(data['O_RCG_SEQ']);
                $('#opCode').val(data['O_OP_CODE']);
                $('#creditBillType').val(data['O_CREDIT_BILL_TYPE']);
                $('#orderNum').val(data['O_ORDERNUM']);
                $('#pgId').val(data['O_PG_ID']);
                $('#noticeContent').val(data['O_NOTIECE_CONTENT']);

                // 팝업 값 셋팅
                popup.find('.popup__desc').html(data['O_NOTIECE_CONTENT']);

                if (phone) {
                    bridge.callAddChargeNumHistory({
                        ctn: phone,
                        date: _ENC.ENC_DATE
                    });
                }

                // 장애등 사유로 충전이 불가할때
                // if (data['O_CHARGE_FLAG'] == 'N') {
                // }

                // DAOU 결제
                if (payAmt > 0 && (data['O_CREDIT_BILL_TYPE'] == 11 || data['O_CREDIT_BILL_TYPE'] == 12)) { 
                    bridgeDaou();
                    return false;
                }

                // Y 면 즉시 충전, N 이면 PG 결제
                if (data['O_PAY_FLAG'] == 'Y') {
                    setPop(popup, true);
                } else {
                    $('#send_form').submit();
                }
            } else {
                alert(res['O_MSG']);
                // history.back();
            }
        });
    });
}

function bridgeDaou(data) {
    var rcgSeq = $('#rcgSeq').val();
    var billType = $('#creditBillType').val();
    var opCode = $('#opCode').val();
    var orderNum = $('#orderNum').val();
    var pgId = $('#pgId').val();
    var noticeContent = $('#noticeContent').val();
    var ctn = $('#ctn').val();
    var mvnoId = $('#mvnoId').val();
    var rcgType = $('#rcgType').val();
    var rcgAmt = parseInt(util.getNum($('#amt').val()));
    var useCash = parseInt(util.getNum($('#useCash').val()));
    var usePoint = parseInt(util.getNum($('#usePoint').val()));
    var payAmt =  rcgAmt - useCash - usePoint;
    var mobileOS = util.getMobileOS();
    var obj = {
        pinNumber: COMM_DATA.pinNumber,
        CTN: ctn,
        USER_ID: COMM_DATA.USER_ID,
        LANG: COMM_DATA.LANG,
        SESSION_ID: COMM_DATA.SESSION_ID,
        ENC_DATE: moment().format('YY-MM-DD HH:mm:ss'),
        OS: (mobileOS == 'and' ? 'ADR':'IOS'),
        appType: 'thePAY',
        ANI: COMM_DATA.ANI,
        opCode: opCode,
        rcgSeq: rcgSeq,
        rcgType: rcgType,
        rcgAmt: rcgAmt,
        payAmt: payAmt,
        CREDIT_BILL_TYPE: billType,
        ORDERNUM: orderNum,
        PG_ID: pgId,
        noti_content: noticeContent
    };
    var urlParams = Object.keys(obj).map(function(k) {
                return (k) + '=' + (obj[k]);
            }).join('&');
    // console.log(urlParams);

    bridge.callGetEncDaouParams({ params: urlParams }, ajax_pg_daou);
}

function ajax_pg_daou(res) {
    // alert('callback');
    // testConsole(JSON.stringify(params))
    api.authCardPaymentDaou(res.params, function(res) {
        if (res['O_CODE'] == '0000') {
            goBack();
        } else {
            alert(res['O_MSG']);
        }
    });
}

// PG 캐시 충전
function ajax_pg_cash() {
    var eDate = moment().format('YYYYMMDDHHmmss');
    bridge.callEncParams({ ENC_DATE: eDate }, function() {
        if (!_ENC) return alert('ENC error');
        var tab = $('.tab_' + _tab);
        var phone = tab.find('.form_phone').val();
        var mvnoId = $('#mvnoId').val();
        var rcgType = $('#rcgType').val();
        var rcgSeq = $('#rcgSeq').val();
        var opCode = $('#opCode').val();
        var rcgAmt = parseInt(util.getNum($('#amt').val()));
        var useCash = parseInt(util.getNum($('#useCash').val()));
        var usePoint = parseInt(util.getNum($('#usePoint').val()));
        var payAmt =  0;
        var params = {
            rcgSeq: rcgSeq,
            rcgMode: 'CASH',
            opCode: opCode, 
            pinNumber: COMM_DATA.pinNumber,
            CTN: phone,
            ANI: phone,
            LANG: COMM_DATA.LANG,
            osLang: COMM_DATA.osLang,
            SESSION_ID: COMM_DATA.SESSION_ID,
            ENC_DATE: _ENC.ENC_DATE,
            AES256: _ENC.AES256,
            rcgType: rcgType,
            rcgAmt: rcgAmt,
            payAmt: 0
        };

        api.rcgCash(params, function(res) {
            if (res['O_CODE'] == '0000') {

                $('#POPUP_pg_confirm').hide();
                var popup = $('#POPUP_finish');
                setPop(popup, true);
            } else {
                alert(res['O_MSG']);
            }
        });
    });
}


function renderPPS(ppsList) {
    if ($.isArray(ppsList)) {
        var target = $('#pps_list');
        var html = [];
        var tpl = '<li  data-id="{{ppsId}}" data-name="{{ppsName}}" class="select_pps {{addClass}}">\
                        <a href="javascript:;">\
                            <div class="tabmenu_inner tabmenu_voice">\
                                <i class="off" style="background-image: url({{imageDefaultUrl}})"></i>\
                                <i class="on" style="background-image: url({{imageSelectUrl}})"></i>\
                                <div class="tabmenu_tit">\
                                    <div class="l-table">\
                                        <div class="l-cell">{{title}}\</div>\
                                    </div>\
                                </div>\
                            </div>\
                        </a>\
                    </li>';

        ppsList.forEach(function(v, i) {
            if (v.ppsId == _defaultPPS) v.addClass = 'on';
            html.push(util.setTemplateObj(tpl, v));
        });

        if (html.length >= 3) {
            target.addClass('col_3').removeClass('col_2');
        } else {
            target.addClass('col_2').removeClass('col_3');
        }

        if (html.length) {
            target.html(html);

            // 기본 아이템 설정
            var item = target.find('.select_pps[data-id='+ _defaultPPS +']');
            selectPPS(item);

        } else target.empty();
    }
}

// 통신사 그리기
function renderMthRate(mthList) {
    if ($.isArray(mthList)) {
        var target = $('#POPUP_mthrate .default_select_inner ul');
        var html = [];
        var tpl = '<li data-id="{{mvnoId}}" data-rcgtype="{{rcgType}}" data-name="{{mvnoName}}" class="select_item">\
                    <input type="radio" id="select_{{mvnoName}}" name="select" value="{{mvnoId}}" {{checked}}>\<label for="select_{{mvnoName}}"><span></span> {{mvnoName}}</label>\
                </li>';

        if (_mthMode == 'band') {
            mthList = mthList.filter(function(mth) { return mth.includeBand == 'Y' });
        }

        mthList.forEach(function(v, i) {
            if (v.mvnoId == _defaultMvnoId) v.addClass = 'on';
            html.push(util.setTemplateObj(tpl, v));
        });

        // console.log(mthList);

        if (html.length) {
            target.html(html);

            // 기본 아이템 설정
            var item = target.find('.select_item[data-id='+_defaultMvnoId+']');
            selectMthRate(item, true);

        } else target.empty();
    }
}


function renderMthRateAmount(amountList, isSetInfo) {
    // console.log('renderMthRateAmount', amountList);
    _sortAmtObj = {}; // 초기화
    var target = $('#recharge_amt_list');
    var html = [];
    var tpl = '<div data-type="{{id}}" class="int_select_inner select_amount_inner">\
                    <a href="javascript:;" id="sel_amt_{{id}}" class="int_select">{{name}}</a>\
                </div>';

    if (_mthMode == 'band') {
        amountList = amountList.filter(function(amt) { return amt.prodType == 'band' });
    }

    amountList.forEach(function(v, i) {
        if (v.amountType in _sortAmtObj) {
            _sortAmtObj[v.amountType].push(v);
        } else {
            _sortAmtObj[v.amountType] = [v];
        }
    });

    // console.log('sort amount list ', _sortAmtObj);

    var amtTypeList = Object.keys(_sortAmtObj);
    var col = amtTypeList.length;

    target.attr('class', 'column col' + col);

    $.each(amtTypeList, function(i, v) {
        var name = '';
        if (v == 2) name = '~29,999';
        else if (v == 3) name = '30,000~';
        else if (v == 4) name = '40,000~';
        else if (v == 5) name = '50,000~';

        html.push(util.setTemplateObj(tpl, {
            id: v,
            name: name
        }));
    });

    if (html.length) {
        target.html(html);

        // 기본 아이템 설정
        // var keys = Object.keys(_sortAmtObj);
        // var sel = amountList.find(function(v) { return v.amount == _defaultRcgAmt });
        // 낮은버전 코드수정
        var sel;
        $.each(amountList, function(i,v) { 
            if(v.amount == _defaultRcgAmt) { sel = amountList[i]; return false; }
        });

        if (!sel) sel = _sortAmtObj[3][0];

        selectAmount(sel, isSetInfo);

    } else target.empty();
}

function renderMthRateAmtSpinner(item) {
    var amtType =  item.data('type');
    var amtList = _sortAmtObj[amtType];

    if ($.isArray(amtList)) {
        // console.log(amtList);
        var target = $('#POPUP_amount .default_select_inner ul');
        var html = [];
        var tpl = '<li data-amttype="{{amtType}}" data-id="{{prodId}}" data-amount="{{amount}}" data-prodtype="{{prodType}}" data-name="{{prodName}}" class="select_amount {{addClass}}">\
                    <input type="radio" id="select_{{prodName}}" name="select" value="{{prodId}}" {{checked}}>\
                    <label for="select_{{prodName}}"><span></span>{{custom}}</label>\
                </li>';

        //console.log(amtList);
        amtList.forEach(function(v, i) {
            v.addClass = '';
            v.checked = '';
            if (i == 0) {
                v.checked = 'checked';
                v.addClass = 'on';
            }
            v.amtType = amtType;

            if (v.prodId > 0) {
                v.custom = '<div class="custom_spinner_item">' + v.prodName + '<br/>'+
                    '<span class="prod_amt">' + _LANG.won + ' ' + util.comma(v.amount) + '</span><br/>' +
                    '<span class="prod_info">' + v.Info1.replace(/<br>/gi, '') + '</span>' +
                    '</div>';
            } else {
                v.custom = v.prodName;
            }

            html.push(util.setTemplateObj(tpl, v));
        });

        if (html.length) {
            target.html(html);
        } else target.empty();
    }
}

function selectPPS(item) {
    var ppsId = item.data('id');
    var ppsName = item.data('name');

    $('#form_ppsName').val(ppsName);

    var tab = $('.tab_' + tab);
    tab.find('.select_pps').removeClass('on');
    item.addClass('on');

//    var pps = _ppsList.find(function(d) { return d.ppsId == ppsId });
    // 낮은버전 코드수정
    var pps;
    $.each(_ppsList, function(i,v) { 
        if(v.ppsId == ppsId) { pps = _ppsList[i]; return false; }
    });

    if (pps) {
        var rcgList = pps.rcgList;
        // console.log('rcgList', rcgList);
        renderRcg(rcgList);
    }
}

// HTML Element 선택
function selectMthRate(item, isSetInfo) {
    var mvnoId = item.data('id');
    var mthName = item.data('name');
    var rcgType = item.data('rcgtype');
    var tab = $('.tab_' + _tab);
    // console.log('selectMthRate', item, mvnoId, mthName, rcgType, isSetInfo);

    tab.find('#mth_select .int_select').text(mthName);

    $('#mvnoId').val(mvnoId);
    $('#rcgType').val(rcgType);

//    var mthRate = _mthList.find(function(m) { return m.mvnoId == mvnoId });
    // 낮은버전 코드수정
    var mthRate;
    $.each(_mthList, function(i,v) { 
        if(v.mvnoId == mvnoId) { mthRate = _mthList[i]; return false; }
    });

    if (mthRate) {
        if (mthRate.imageDefaultUrl) $('.news_agency_img img').attr('src', mthRate.imageDefaultUrl);

        if ($.isArray(mthRate.amounts)) {
            renderMthRateAmount(mthRate.amounts, isSetInfo);
        }
    }
}

// Obj data 선택
function selectMthRateV2(itemObj) {
    // console.log('obj data', itemObj)
    var mvnoId = itemObj.mvnoId;
    var mthName = itemObj.mvnoName;
    var rcgType = itemObj.rcgType;
    var tab = $('.tab_' + _tab);
    // console.log('selectMthRateV2', itemObj);

    tab.find('#mth_select .int_select').text(mthName);

    $('#mvnoId').val(mvnoId);
    $('#rcgType').val(rcgType);

    if (itemObj.imageDefaultUrl) $('.news_agency_img img').attr('src', itemObj.imageDefaultUrl);

    if ($.isArray(itemObj.amounts)) {
        renderMthRateAmount(itemObj.amounts);
    }
}

function selectItem(item) {
    var mvnoId = item.data('id');
    var amount = item.data('amount');
    var rcgType = item.data('rcgtype');
    var name = item.data('name');
    var tab = $('.tab_' + _tab);
    // console.log('select item ', item);

    tab.find('.int_select_inner .int_select').text(name);
    tab.find('#form_amount').html('<option value="'+amount+'">₩ '+util.comma(amount)+'</option>');
    $('#amount, #payment_amount').text(_LANG.won+ ' ' + util.comma(amount));
    $('#mvnoId').val(mvnoId);
    $('#amt').val(amount);
    $('#payAmt').val(amount);
    $('#rcgType').val(rcgType);
    renderPoint();
}

function selectAmount(item, isSetInfo) {
    // console.log(item);

    $('#recharge_amt_list').find('.int_select_inner').each(function() {
        var type = $(this).data('type');

        if (type != item.amountType) {
            var name = '';
            if (type == 2) name = '~29,999';
            else if (type == 3) name = '30,000~';
            else if (type == 4) name = '40,000~';
            else if (type == 5) name = '50,000~';

            $(this).find('.int_select').text(name);
        }
    });

    var tab = $('.tab_' + _tab);
    tab.find('#form_amount').val((item.prodName));
    $('#amount, #payment_amount').text(_LANG.won+ ' ' + util.comma(item.amount));
    $('#sel_amt_' + item.amountType).text(_LANG.won+ ' ' + util.comma(item.amount));
    if (isSetInfo) $('#info').html(item.Info1);

    $('#mvnoId').val(item.prodId);
    $('#amt').val(item.amount);
    $('#payAmt').val(item.amount);

    renderPoint();
}

function renderRcg(rcgList) {
    var target = $('#POPUP_dataCheck .default_select_inner');
    var html = [];
    var tpl = '<li data-id="{{mvnoId}}" data-rcgtype="{{rcgType}}" data-amount="{{amounts}}" data-name="{{mvnoName}}">\
                <input type="radio" id="select_{{mvnoName}}" name="select" value="{{amounts}}" {{checked}}><label for="select_{{mvnoName}}"><span></span> {{mvnoName}}</label>\
            </li>';

    var firstSel = {};

    rcgList.forEach(function (v, i) {
        v.checked = '';
        if (i == 0) {
            v.checked = 'checked';
        }
        html.push(util.setTemplateObj(tpl, v));
    });

    if (html.length) {
        target.html(html);

        var item = target.find('li').eq(0);
        selectItem(item);
    } else {
        target.empty();
    }
}

function setTelecom(mvnoId, amt) {
//    var telecom = _mthList.find(function (mth) { return mth.mvnoId == mvnoId });
    // 낮은버전 코드수정
    var telecom;
    $.each(_mthList, function(i,v) { 
        if(v.mvnoId == mvnoId) { telecom = _mthList[i]; return false; }
    });

//    if (!telecom) telecom = _mthList.find(function (mth) { return mth.mvnoId == -999 });
    // 낮은버전 코드수정
    if(!telecom){
        $.each(_mthList, function(i,v) { 
            if(v.mvnoId == -999) { telecom = _mthList[i]; return false; }
        });
    }

    selectMthRateV2(telecom);

    // amt 있을때만 선택 하면 된다.
    // selectMthRateV2 에서 기본값 설정됨.
    if (amt) {
        var keys = Object.keys(_sortAmtObj);
        var selAmt;

        //console.log('여기인가', amt, _sortAmtObj, keys);
        $.each(keys, function(i, k) {
//            selAmt = _sortAmtObj[k].find(function(v) { return v.amount == amt });
            // 낮은버전 코드수정
            $.each( _sortAmtObj[k], function(idx,val) { 
                if(val.amount == amt) { selAmt = _sortAmtObj[k][idx]; return false; }
            });

            // break
            if (selAmt) return false;
        });

        if (!selAmt) selAmt = _sortAmtObj[3][0];

        // console.log('selAmt', selAmt);
        selectAmount(selAmt, false);
    }
}

function setPageComm() {
    _auth_ctn = COMM_DATA.ANI;
    var params = util.getUrlParams();

    if (params['tab_type']) {
        // alert(JSON.stringify(params));

        var tabType = params['tab_type'];
        var tabEl = $('.l__tabmenu li').eq(tabType - 1);
        var tab = tabEl.data('tab');
        tabEl.addClass('on').siblings().removeClass('on');
        _tab = tab;
        $('.tab_' + _tab).show().siblings('.tab').hide();

        if (tabType == 1 && params['product_type']) {
            var pdType = params['product_type'];

            // 예외처리
            if (pdType == 3) {
                _defaultPPS = 'data';
            } else if (pdType == 1) {
                _defaultPPS = 'voice2';
            } else {
                _defaultPPS = 'voice';
            }
        } else if (tabType == 2) {
            if (params['mvno_id']) _defaultMvnoId = params['mvno_id'];
            if (params['rcg_amt']) _defaultRcgAmt = params['rcg_amt'];
        }

        if (params['ctn']) {
            _auth_ctn = params['ctn'];
            _isLoadCtn = false;
        }
    }

    /* 상단탭 두줄 표기 시 line-height 조정 */
    var tab_mthRate = _LANG.tab_title_charge_monthly;
    var tab_pps = _LANG.tab_title_charge_normal;

    if(tab_pps.indexOf("\\n") != -1) $('.l__tabmenu li[data-tab=pps]').css('line-height','1.5');
    if(tab_mthRate.indexOf("\\n") != -1) $('.l__tabmenu li[data-tab=mthRate]').css('line-height','1.5');
}

function pageLoadInit() {
    // 모든 기능은 App으로 부터 기본 정보를 받은 후 진행
    bridge.callCommonParams(function() {
        commonInit(); // XML LANG load

        setPageComm();

        bridge.callSetWebViewTitle({ 
            title: _LANG.title_activity_charge_integrate 
        });

        // mustache render
        pageInit();

        // 기본값 설정
        setCTN(1);

        ajax_page_info(_isLoadCtn);
        ajax_page_remains();

        // after mustache render
        pageActionInit();

    });
}

function setCTN(type) {
    // console.log('setCTN >> ', type);
    var tab = $('.tab_' + _tab);
    var ctn = String(_auth_ctn).replace(/(^0[0-9]{2})([0-9]{4})([0-9]{4})/,"$1-$2-$3").replace("--", "-");
    tab.find('.form_phone').val(ctn);
}

// 페이지 이벤트 구현부
function pageActionInit() {
    // 뒤로 가기
    $('.head__back').on('click', function() {
        history.back();
    });

    // 팝업닫기
    $('.popup__close,.dim').on('click', function(e) {
        e.preventDefault();e.stopPropagation();
        setPop($('.l__popup'), false);
    });

    // 탭 
    $('.l__tabmenu li').on('click', function() {
        $(this).addClass('on').siblings().removeClass('on');
        var tab = $(this).data('tab');

        if (tab == _tab) return false;
        // _auth_ctn = COMM_DATA.ANI;
        _tab = tab;

        $('.tab_'+tab).fadeIn(150).siblings('.tab').hide();

        _auth_ctn = COMM_DATA.ANI; // 검색 값 유지 하지 않음
        setCTN(2);

        // 탭변경시 재호출
        ajax_page_info(true);
    });

    $(document).on('click', '.int_select_inner',function(e) {
        e.preventDefault(); e.stopPropagation();
        if (_tab == 'pps') setPop($('#POPUP_dataCheck'), true);
        else {
            if ($(this).hasClass('select_amount_inner')) {
                renderMthRateAmtSpinner($(this));
                setPop($('#POPUP_amount'), true);
            } else setPop($('#POPUP_mthrate'), true);
        }
    });

    $(document).on('click', '.select_pps', function(e) {
        e.preventDefault();e.stopPropagation();
        var $this = $(this);

        $this.addClass('on').siblings('.select_pps').removeClass('on');

        selectPPS($this);
    });

    $(document).on('click', '.select_item', function(e) {
        e.preventDefault();e.stopPropagation();
        var $this = $(this);

        $this.addClass('on').siblings('.select_item').removeClass('on');
    });

    $('.btn_sel_mth').on('click', function() { 
        var sel = $('#POPUP_mthrate .select_item.on');
        
        if (!sel.length) return false;

        selectMthRate(sel, false);
        setPop($('.l__popup'), false);
        $(document).scrollTop($('#WRAP').prop('scrollHeight'));
    });

    $(document).on('click', '.select_amount', function(e) {
        e.preventDefault();e.stopPropagation();
        var $this = $(this).addClass('on').siblings('.select_amount').removeClass('on');
    });

    $('.btn_sel_amount').on('click', function() { 
        var sel = $('.select_amount.on');

        if (!sel.length) return false;

        var amtType = sel.data('amttype');
        var prodId = sel.data('id');
        var amount = sel.data('amount');
        var prodType = sel.data('prodtype');

        // console.log(' select amt! ',amtType, _sortAmtObj[amtType])

//        var item = _sortAmtObj[amtType].find(function(v) {
//            return v.prodId == prodId && v.amount == amount && v.prodType == prodType;
//        });
        // 낮은버전 코드수정
        var item;
        $.each(_sortAmtObj[amtType], function(i,v) { 
            if(v.prodId == prodId && v.amount == amount && v.prodType == prodType) { item = _sortAmtObj[amtType][i]; return false; }
        });

        if (item) {
            selectAmount(item, true);
            setPop($('.l__popup'), false);

            $(document).scrollTop($('#WRAP').prop('scrollHeight'));
        }
    });

    // 상품 선택
    $(document).on('click', '.default_select_inner li',function(e) {
        e.preventDefault(); e.stopPropagation();
        var target = $(this);
        target.find('input').prop('checked', true);
    });

    $('.btn_sel').on('click', function(e) { 
        e.preventDefault(); e.stopPropagation();
        var popup = $('#POPUP_dataCheck');
        var target = popup.find('input[type=radio]:checked');

        if (!target.length) {
            return false;
        }

        selectItem(target.parents('li'));
        setPop($('.l__popup'), false);

        $(window).scrollTop($('body').prop('scrollHeight'));
    });

    $('.phone').on('keyup', function(e) {

        var phone = $(this).val().replace(/[^0-9]/g, "");

        if (phone.length > 11) {
            phone = phone.substr(0, 11);
        }

        phone = phone.replace(/(^0[0-9]{2})([0-9]{4})([0-9]{4})/,"$1-$2-$3").replace("--", "-");
        $(this).val(phone);

        if (util.getNum(phone).length == 11) {
            if (!_isApiLoading) {
                _isApiLoading = true;
                e.stopPropagation(); e.preventDefault();
                ajax_auth_ctn(true);
            }
        }
    });

    // 충전 유효성 검사
    $('#btn_recharge').on('click', function() {
        var tab = $('.tab_' + _tab);
        var phone = tab.find('.form_phone').val();
        var mvnoId = $('#mvnoId').val();
        var amt = $('#amt').val();
        var payAmt = $('#payAmt').val();

        if (!util.getNum(phone).length) {
            alert(_LANG.toast_empty_recharge_number);
            tab.find('.form_phone').focus();
            return false;
        }

        if (!amt) {
            alert(_LANG.toast_empty_recharge_number);
            return false;
        }

        ajax_rcg_fail_note();
    });

    // 충전 진행
    $('.btn_pg_confirm').on('click', function() {
        ajax_pg_cash();
    });

    $('.checkbox_wrap').on('click', function(e) {
        e.stopPropagation(); e.preventDefault();
//        var target = $(this).find('input[type=checkbox]');
        var target = $(this).find('.use_checkbox');
        var isChecked = target.prop('checked');

        if ($(this).find('.int_check').css('display') == 'none') return false;

        // 1개만 선택
//        $('input[type=checkbox]:checked').prop('checked', false);
        $('.use_checkbox').prop('checked', false);
        target.prop('checked', !isChecked);

        if (target.prop('checked')) {
            if (target.attr('id') == 'use_point') {
                _userSelCash = 'point';
            } else {
                _userSelCash = 'cash';
            }
        }

        // payAmt 계산
        calcPayAmt();
    });

    // 탭이동 처리
    $('.btn_month_confirm').on('click', function() {
        var tabEl = $('.l__tabmenu li.on');
        var tab = tabEl.data('tab');
        var ctn = $('.tab_'+tab).find('.form_phone').val();

        $('.l__tabmenu li[data-tab=mthRate]').click();
        _tab = 'mthRate';

        $('.tab_'+_tab).fadeIn(150).siblings('.tab').hide();

        _auth_ctn = ctn; // 검색 값 유지 하지 않음
        setCTN(2)
        
        // 탭변경시 재호출
        ajax_page_info(true);
        setPop($(this).parents('.l__popup'), false);
    });

    // 탭이동 처리
    $('.btn_normal_confirm').on('click', function() {
        var tabEl = $('.l__tabmenu li.on');
        var tab = tabEl.data('tab');
        var ctn = $('.tab_'+tab).find('.form_phone').val();

        $('.l__tabmenu li[data-tab=pps]').click();
        _tab = 'pps';

        $('.tab_'+_tab).fadeIn(150).siblings('.tab').hide();

        _auth_ctn = ctn; // 검색 값 유지 하지 않음
        setCTN(2);

        // 탭변경시 재호출
        ajax_page_info(true);
        setPop($(this).parents('.l__popup'), false);
    });

    $('.btn_Address').on('click', function (e) {
        var countryCode = 'kr';
        var tabType = 'commonContact';
        var pageType = 'charge';
        var dataType = 'num';
        var inputId = $(this).prevAll('input').attr('id');

        bridge.callGoToContact({
            countryCode: countryCode,
            tabType: tabType,
            pageType: pageType,
            dataType: dataType,
            inputId: inputId
        });
    });

    $('.btn_History2').on('click', function (e) {
        var countryCode = 'kr';
        var tabType = 'commonHistory';
        var pageType = 'charge';
        var dataType = 'num';
        var inputId = $(this).prevAll('input').attr('id');

        bridge.callGoToContact({
            countryCode: countryCode,
            tabType: tabType,
            pageType: pageType,
            dataType: dataType,
            inputId: inputId
        });
    });

    $('.btn_finish_confirm,#POPUP_finish .dim').on('click', function (e) {
        e.preventDefault(); e.stopPropagation();
        location.replace('/rcgHistory.html');
    });
}

$(function(){
    pageLoadInit();
});
</script>
</body>
</html>
